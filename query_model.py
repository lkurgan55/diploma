from transformers import AutoTokenizer, AutoModelForCausalLM
import torch

from decoding.greedy import GreedyStrategy
from decoding.beam import BeamStrategy

MODEL_DIR = "./models/llama-3-8b-instruct"

def load_model(model_dir: str):
    tokenizer = AutoTokenizer.from_pretrained(model_dir)
    model = AutoModelForCausalLM.from_pretrained(
        model_dir,
        torch_dtype=torch.float16 if torch.cuda.is_available() else torch.float32,
        device_map=None,
    )
    device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
    model.to(device)
    return tokenizer, model, device

if __name__ == "__main__":
    tokenizer, model, device = load_model(MODEL_DIR)

    prompt = '<|begin_of_text|><|start_header_id|>system<|end_header_id|>\n\nYou are a Text-to-SQL generator for SQLite dialect.\nUse only table and column names exactly as in the schema.\nReturn EXACTLY ONE SQL query and NOTHING ELSE.\nDo NOT use markdown or code fences.\nStart the query with SELECT or WITH.\nEnd your output with a single semicolon \';\' and then stop.\nNo explanations, no comments.<|eot_id|><|start_header_id|>user<|end_header_id|>\n\nSchema:\nCREATE TABLE event\n(\n    event_id   TEXT\n        constraint event_pk\n            primary key,\n    event_name TEXT,\n    event_date TEXT,\n    type       TEXT,\n    notes      TEXT,\n    location   TEXT,\n    status     TEXT\n) \n /* \n 5 example rows: \n SELECT * FROM event LIMIT 5; \n          event_id                 event_name          event_date     type                                                         notes                       location   status \nrec0Si5cQ4rJRVzd6              March Meeting 2020-03-10T12:00:00  Meeting                                                          None                         MU 215     Open \nrec0akZnLLpGUloLH Officers meeting - January 2020-01-14T09:30:00  Meeting                                                          None                           None     Open \nrec0dZPcWXF0QjNnE           Spring Elections 2019-11-24T09:00:00 Election All active members can vote for new officers between 4pm-8pm.                         MU 215     Open \nrec180D2MI4EpckHy   Officers meeting - March 2020-03-10T09:30:00  Meeting                                                          None                           None Planning \nrec2N69DMcrqN9PJC             Women\'s Soccer 2019-10-05T12:00:00     Game                        Attend Women\'s soccer game as a group. Campus Soccer/Lacrosse stadium   Closed  \n */\n\nCREATE TABLE major\n(\n    major_id   TEXT\n        constraint major_pk\n            primary key,\n    major_name TEXT,\n    department TEXT,\n    college    TEXT\n) \n /* \n 5 example rows: \n SELECT * FROM major LIMIT 5; \n          major_id                             major_name                                           department                                     college \nrec06DF6vZ1CyPKpc Outdoor Product Design and Development School of Applied Sciences, Technology and Education College of Agriculture and Applied Sciences \nrec09LedkREyskCNv             Agricultural Communication School of Applied Sciences, Technology and Education College of Agriculture and Applied Sciences \nrec0Eanv576RhQllI         Fisheries and Aquatic Sciences                        Watershed Sciences Department                College of Natural Resources \nrec0xRZtkzxrg8kj2                                Finance                     Economics and Finance Department                          School of Business \nrec1N0upiVLy5esTO          Forest Ecology and Management                        Wildland Resources Department                College of Natural Resources  \n */\n\nCREATE TABLE zip_code\n(\n    zip_code    INTEGER\n        constraint zip_code_pk\n            primary key,\n    type        TEXT,\n    city        TEXT,\n    county      TEXT,\n    state       TEXT,\n    short_state TEXT\n) \n /* \n 5 example rows: \n SELECT * FROM zip_code LIMIT 5; \n zip_code     type       city              county       state short_state \n     501   Unique Holtsville      Suffolk County    New York          NY \n     544   Unique Holtsville      Suffolk County    New York          NY \n     601 Standard   Adjuntas  Adjuntas Municipio Puerto Rico          PR \n     602 Standard     Aguada    Aguada Municipio Puerto Rico          PR \n     603 Standard  Aguadilla Aguadilla Municipio Puerto Rico          PR  \n */\n\nCREATE TABLE "attendance"\n(\n    link_to_event  TEXT,\n    link_to_member TEXT,\n    primary key (link_to_event, link_to_member),\n    foreign key (link_to_event) references event(event_id),\n    foreign key (link_to_member) references member(member_id)\n) \n /* \n 5 example rows: \n SELECT * FROM attendance LIMIT 5; \n     link_to_event    link_to_member \nrec2N69DMcrqN9PJC recD078PnS3x2doBe \nrec2N69DMcrqN9PJC recP6DJPyi5donvXL \nrec2N69DMcrqN9PJC rec28ORZgcm1dtqBZ \nrec2N69DMcrqN9PJC recTjHY5xXhvkCdVT \nrec2N69DMcrqN9PJC recZ4PkGERzl9ziHO  \n */\n\nCREATE TABLE "budget"\n(\n    budget_id     TEXT\n            primary key,\n    category      TEXT,\n    spent         REAL,\n    remaining     REAL,\n    amount        INTEGER,\n    event_status  TEXT,\n    link_to_event TEXT,\n    foreign key (link_to_event) references event(event_id)\n) \n /* \n 5 example rows: \n SELECT * FROM budget LIMIT 5; \n         budget_id      category  spent          remaining amount event_status     link_to_event \nrec0QmEc3cSQFQ6V2 Advertisement  67.81               7.19     75       Closed recI43CzsZ0Q625ma \nrec1bG6HSft7XIvTP          Food 121.14              28.86    150       Closed recggMW2eyCYceNcy \nrec1z6ISJU2HdIsVm          Food   20.2 -0.199999999999999     20       Closed recJ4Witp9tpjaugn \nrec33PFqxLtnp80RJ Speaker Gifts    0.0               25.0     25         Open recHaMmaKyfktt5fW \nrec4DYUKBHMPZXWB2          Food    0.0              150.0    150         Open recHaMmaKyfktt5fW  \n */\n\nCREATE TABLE "expense"\n(\n    expense_id          TEXT\n            primary key,\n    expense_description TEXT,\n    expense_date        TEXT,\n    cost                REAL,\n    approved            TEXT,\n    link_to_member      TEXT,\n    link_to_budget      TEXT,\n    foreign key (link_to_budget) references budget(budget_id),\n    foreign key (link_to_member) references member(member_id)\n) \n /* \n 5 example rows: \n SELECT * FROM expense LIMIT 5; \n        expense_id expense_description expense_date   cost approved    link_to_member    link_to_budget \nrec017x6R3hQqkLAo Post Cards, Posters   2019-08-20 122.06     true rec4BLdZHS2Blfp4v recvKTAWAFKkVNnXQ \nrec1nIjoZKTYayqZ6      Water, Cookies   2019-10-08   20.2     true recro8T1MPMwRadVH recy8KY5bUdzF81vv \nrec1oMgNFt7Y0G40x               Pizza   2019-09-10  51.81     true recD078PnS3x2doBe recwXIiKoBMjXJsGZ \nrec4Zg7WEmfiHXcnC             Posters   2019-10-10  67.81     true rec4BLdZHS2Blfp4v recsI0IzpUuxl2bPh \nrec7gUiykKKW4RaJS             Parking   2019-11-19    6.0     true recro8T1MPMwRadVH recTUGXxhTaFZ2qkg  \n */\n\nCREATE TABLE "income"\n(\n    income_id      TEXT\n        constraint income_pk\n            primary key,\n    date_received  TEXT,\n    amount         INTEGER,\n    source         TEXT,\n    notes          TEXT,\n    link_to_member TEXT,\n    foreign key (link_to_member) references member(member_id)\n) \n /* \n 5 example rows: \n SELECT * FROM income LIMIT 5; \n         income_id date_received amount source notes    link_to_member \nrec0s9ZrO15zhzUeE    2019-10-17     50   Dues  None reccW7q1KkhSKZsea \nrec7f5XMQZexgtQJo    2019-09-04     50   Dues  None recTjHY5xXhvkCdVT \nrec8BUJa8GXUjiglg    2019-10-08     50   Dues  None recUdRhbhcEO1Hk5r \nrec8V9BPNIoewWt2z    2019-10-02     50   Dues  None rec3pH4DxMcWHMRB7 \nrecCRWMfFqifuKMc6    2019-09-18     50   Dues  None rec28ORZgcm1dtqBZ  \n */\n\nCREATE TABLE "member"\n(\n    member_id     TEXT\n        constraint member_pk\n            primary key,\n    first_name    TEXT,\n    last_name     TEXT,\n    email         TEXT,\n    position      TEXT,\n    t_shirt_size  TEXT,\n    phone         TEXT,\n    zip           INTEGER,\n    link_to_major TEXT,\n    foreign key (link_to_major) references major(major_id),\n    foreign key (zip) references zip_code(zip_code)\n) \n /* \n 5 example rows: \n SELECT * FROM member LIMIT 5; \n         member_id first_name last_name                  email position t_shirt_size          phone   zip     link_to_major \nrec1x5zBFIqoOuPW8     Angela   Sanders angela.sanders@lpu.edu   Member       Medium (651) 928-4507 55108 recxK3MHQFbR9J5uO \nrec280Sk7o31iG0Tx      Grant   Gilmour  grant.gilmour@lpu.edu   Member      X-Large   403-555-1310 29440 rec7BxKpjJ7bNph3O \nrec28ORZgcm1dtqBZ      Luisa     Guidi    luisa.guidi@lpu.edu   Member       Medium   442-555-5882 10002 recdIBgeU38UbV2sy \nrec2a03QXbFQAUZ7X      Randy   Woodard  randy.woodard@lpu.edu Inactive      X-Large   490-555-8460  8021              None \nrec3pH4DxMcWHMRB7     Connor    Hilton  connor.hilton@lpu.edu   Member      X-Large   454-555-7970 48236 recaJdSK83k6ekRJL  \n */\n\nInstruction: Among the students from the Student_Club who attended the event "Women\'s Soccer", how many of them want a T-shirt that\'s in medium size?\nOutput: SQL only, one statement, end with \';\'<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n'

    #strategy = GreedyStrategy(model=model, tokenizer=tokenizer)
    strategy = BeamStrategy(model=model, tokenizer=tokenizer)
    

    #sql = strategy.generate(prompt, max_new_tokens=120)
    #print("\n=== SQL (fast) ===\n", sql)

    sql_dbg = strategy.custom_generate(prompt, debug=True, max_steps=120)
    print("\n=== SQL (debug) ===\n", sql_dbg)
